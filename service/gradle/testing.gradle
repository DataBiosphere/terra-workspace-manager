// Testing Tasks Configuration

// The path to the default Google service account for the Workspace Manager to run as.
// Created by render_config.sh
def googleCredentialsFile = "${projectDir}/rendered/service-account.json"
bootRun {
    environment = [
            'GOOGLE_APPLICATION_CREDENTIALS': "${googleCredentialsFile}"
    ]
}
tasks.withType(Test) {
    environment = [
            'GOOGLE_APPLICATION_CREDENTIALS': "${googleCredentialsFile}"
    ]
}

jacocoTestReport {
    reports {
        xml.enabled = true
        xml.destination = file("$buildDir/reports/jacoco/test/jacoco.xml")
    }
    dependsOn test
}

// default test to unit tests so the build target succeeds
test {
    useJUnitPlatform {
        includeTags "unit"
    }
}

task unitTest(type: Test) {
    useJUnitPlatform {
        includeTags "unit"
    }
    testLogging {
        events = ["passed", "failed", "skipped", "started"]
    }
    outputs.upToDateWhen { false }
    finalizedBy jacocoTestReport
}

task connectedTest(type: Test) {
    environment.put('TEST_ENV', System.getenv("TEST_ENV"))
    useJUnitPlatform {
        includeTags "connected"
    }
    testLogging {
        events = ["passed", "failed", "skipped", "started"]
    }
    outputs.upToDateWhen { false }
}


task integrationTest(type: Test) {
    environment.put('TEST_ENV', System.getenv("TEST_ENV"))
    useJUnitPlatform {
        includeTags "integration"
    }
    testLogging {
        events = ["passed", "failed", "skipped", "started"]
    }
    outputs.upToDateWhen { false }
}

jacoco {
    toolVersion = '0.8.2'
}
